{% extends "main/video_source.html" %}
{% block title %}
  Admin
{% endblock title %}
{% block head %}
  {{ super() }}
  {{ bootstrap.load_css() }}
{% endblock head %}
{% block content %}
  <div class="card">
    <div class="card-header">
      <ul class="nav nav-tabs card-header-tabs">
        <li class="nav-item">
          <a class="nav-link active" aria-current="true" href="#">Active</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">Link</a>
        </li>
        <li class="nav-item">
          <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">Disabled</a>
        </li>
        <li class="nav-item ms-auto">
          <a class="btn btn-sm btn-primary">Refresh ALL</a>
        </li>
      </ul>
    </div>
    <div class="card-body" id="vidCards">
      
    </div>
  </div>
  {{ super() }}
{% endblock content %}
{% block scripts %}
  {{ super() }}
  <script type="module">
    function make_card(vid) {
      let card = document.createElement("div");
      card.classList.add("card","d-inline-block", "m-1");
      card.style.width = "18rem";
      card.id = vid['id']
      let img = document.createElement("img");
      img.src = vid['preview'];
      img.classList.add("card-img-top");
      card.appendChild(img);
      let cardBody = document.createElement("div");
      cardBody.classList.add("card-body");
      card.appendChild(cardBody);
      let card_text = document.createElement("p");
      card_text.classList.add("card-text");
      card_text.innerHTML = vid['description'];
      cardBody.appendChild(card_text);
      let buttonGroup = document.createElement("div");
      buttonGroup.classList.add("d-flex", "justify-content-between");
      cardBody.appendChild(buttonGroup);
      let project = document.createElement("a");
      project.classList.add("btn", "btn-danger","me-auto");
      project.innerHTML = "Project";
      project.onclick = () => {
        console.log("project clicked");
      };
      buttonGroup.appendChild(project);
      let refresh = document.createElement("a");
      refresh.classList.add("btn", "btn-primary", "ms-auto");
      refresh.innerHTML = "Refresh";
      refresh.onclick = (event) => {
        const vidId = event.target.parentNode.parentNode.parentNode.id;
        socket.emit("refreshPreview", vidId);
      }
      buttonGroup.appendChild(refresh);
      return card;
    }

    socket.on("admin joined", () => {
      fetch('/video_devices')
      .then(response => response.json())
      .then(data => {
        let vidCards = document.getElementById("vidCards");
        for(let device in data) {
          for(let vid of data[device]) {
            vidCards.appendChild(make_card(vid));
          }
        }
      });
    })

    socket.on("admin rejected",()=>{
      alert("Admin rejected");
      window.location.href = '/video_source'
    })

    socket.on("videoRefreshed",(data)=>{
      for(let key in data){
        const cardToUpdate = document.getElementById(key);
        cardToUpdate.children[0].src = data[key];
      }
    })

    socket.emit("registerAdmin");

    
    
    //document.getElementById("vidCards").appendChild(make_card());
  </script>
  {{ bootstrap.load_js() }}
{% endblock scripts %}
